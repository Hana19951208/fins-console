<template>
  <div style="height: 100%">
    <div class="layui-side">
      <el-tree
        :data="menuTreeDs"
        :props="defaultProps"
        :load="loadNode"
        :default-expanded-keys="keyTree"
        :expand-on-click-node="false"
        :highlight-current="true"
        node-key="id"
        lazy
        @node-click="treeSelectHandle"
      />
    </div>
    <div class="layui-body">
      <i-search-el-table
        ref="table"
        advanceQuery
        :query-form="queryForm"
        :columns="columns"
        :data="data"
        :loading="loading"
        :index="true"
        @pagination="initDataTable"
        :hasCheckBox="false"
      >
        <template slot="simple-form">
          <el-form-item @submit.native.prevent>
            <el-input
              v-model.trim="queryForm.phone"
              :maxlength="50"
              size="small"
              placeholder="请输入手机号"
              clearable
            >
              <el-button
                slot="append"
                icon="el-icon-search"
                @click="$refs.table.handleFilter()"
              />
            </el-input>
          </el-form-item>
        </template>
        <template slot="search-form">
          <el-form-item label="姓名：" prop="name">
            <el-input
              v-model="queryForm.name"
              style="width: 220px"
              placeholder="请输入姓名"
              clearable
            />
          </el-form-item>
          <el-form-item label="开始时间：" prop="startTime">
            <el-date-picker
              :picker-options="pickerOptions0"
              v-model="queryForm.startTime"
              type="date"
              value-format="yyyy-MM-dd"
              placeholder="请选择开始时间"
            />
          </el-form-item>
          <el-form-item label="结束时间：" prop="endTime">
            <el-date-picker
              :picker-options="pickerOptions1"
              v-model="queryForm.endTime"
              type="date"
              value-format="yyyy-MM-dd"
              placeholder="请选择结束时间"
            />
          </el-form-item>
        </template>
        <template slot="resolve" slot-scope="{ scope }">
          {{ scope.row.resolve | isNUllToZero }}
        </template>
        <template slot="noResolve" slot-scope="{ scope }">
          {{ scope.row.noResolve | isNUllToZero }}
        </template>
        <template slot="isValid" slot-scope="{ scope }">
          {{ scope.row.isValid | dictFormat(isValidDs) }}
        </template>
        <template slot="contents" slot-scope="{ scope }">
          <el-link
            :underline="false"
            type="primary"
            class="blue--text text--darken-2"
            @click="todetial(scope.row.id)"
          >
            {{ scope.row.contents }}
          </el-link>
        </template>
      </i-search-el-table>
    </div>
    <detial
      v-model="detialSHow"
      :selection="selectionId"
      @show="detialSHow = false"
      @refreshTable="initDataTable"
    />
  </div>
</template>

<script>
import ISearchElTable from "@/components/ISearchElTable";
import { getDictEntrysByCode } from "@/utils";
import * as utils from "@/utils";
import detial from "./detial";
export default {
  name: "feedback",
  components: { ISearchElTable, detial },
  filters: {
    isNUllToZero(value) {
      if (value) {
        return value;
      } else {
        return "0";
      }
    },
  },
  data() {
    return {
      detialSHow: false,
      selectionId: null,
      columns: [
        { label: "内容", key: "contents", align: "center" },
        { label: "姓名", key: "name", align: "center" },
        { label: "手机号", key: "phone", align: "center" },
        { label: "提交时间", key: "createTime", align: "center" },
      ],
      queryForm: {
        pageNum: 1,
        pageSize: 10,
        phone: null,
        name: null,
        startTime: null,
        endTime: null,
        channel: "",
        questType: "",
      },
      pickerOptions0: {
        disabledDate: (time) => {
          if (this.queryForm.endTime) {
            return time.getTime() > new Date(this.queryForm.endTime).getTime();
          }
        },
      },
      pickerOptions1: {
        disabledDate: (time) => {
          if (this.queryForm.startTime) {
            return (
              time.getTime() <
              new Date(this.queryForm.startTime).getTime() - 86400000
            );
          }
        },
      },
      data: {},
      loading: false,
      defaultProps: {
        children: "children",
        label: "name",
        isLeaf: function (val) {
          return val.isoperate === 2;
        },
      },
      isValidDs: [
        {
          code: 1,
          name: "有效",
        },
        {
          code: 0,
          name: "无效",
        },
      ],
      selection: {},
      addDialog: {
        show: false,
      },
      isView: false,
      menuTreeDs: [],
      node: {},
      keyTree: [],
      selectionThree: {},
      channel: null,
      questType: null,
    };
  },
  computed: {
    typeDs() {
      return getDictEntrysByCode("CORE.RESOURCE.TYPE");
    },
    productTypeDs() {
      return getDictEntrysByCode("PRODUCT_TYPE");
    },
  },
  mounted() {
    this.initDataTable();
  },
  methods: {
    initDataTable() {
      this.loading = true;
      this.queryForm.channel = this.channel;
      this.queryForm.questType = this.questType;
      this.$api.feedback.selectFeedbackInfoList(this.queryForm).then((res) => {
        this.data = res;
        this.loading = false;
      });
    },
    treeSelectHandle(data, node) {
      this.channel = node.parent.data.channel || data.channel;
      this.questType = data.channel ? "" : data.code;
      this.initDataTable();
    },
    loadNode(node, resolve) {
      this.$api.feedback.getFeedbackTree({ id: node.data.id }).then((res) => {
        const data = res.body;
        data.map((item, index) => {
          if (data[index] && data[index].isoperate < 2) {
            this.keyTree.push(data[index].id);
          }
        });
        resolve(data);
      });
    },
    addHandle() {
      this.isView = false;
      this.selection = {};
      this.addDialog.show = true;
      // 重置子组件form表单
      console.info();
    },
    editHandle() {
      this.isView = false;
      if (this.$refs.table.isCheckedOne()) {
        // console.info(this.$refs.table.selection)
        this.selection = this.$refs.table.selection[0];
        this.addDialog.show = true;
      }
    },
    delHandle() {
      if (this.$refs.table.isChecked()) {
        const selection = this.$refs.table.selection;
        const ids = [];
        selection.forEach((item) => {
          ids.push(item.id);
        });
        // console.log(selection)
        this.$refs.table
          .delConfirm({ message: "确定要删除选择的内容吗?" })
          .then(() => {
            this.$api.feedback.delHelp({ ids: ids.join(",") }).then(() => {
              this.$message({
                message: utils.GLOBAL.OPERATE_SUCCESS,
                type: "success",
              });
              this.queryForm.pageNum = 1;
              this.initDataTable();
            });
          });
      }
    },
    viewHandler(index) {
      this.isView = true;
      this.selection = this.$refs.table.tableData[index];
      this.addDialog.show = true;
    },
    todetial(data) {
      this.detialSHow = true;
      this.selectionId = data;
      console.log(this.detialSHow);
    },
  },
};
</script>

<style scoped>
/* .layui-side {
  width: 200px;
}
.layui-body {
  left: 220px;
} */
</style>
